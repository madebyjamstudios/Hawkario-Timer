<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self';" />
  <title>Ninja Timer — Control</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../shared/base.css" />
  <link rel="stylesheet" href="control.css" />
</head>
<body>
  <header>
    <div class="hawk-icon" aria-hidden="true">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2c4.8 0 8.5 3.7 8.5 8.5 0 2.6-1.1 4.9-2.9 6.5-.5.5-1.2.5-1.7 0-.4-.4-.4-1 0-1.5 1.3-1.2 2.1-2.9 2.1-4.8 0-3.8-3.1-6.9-6.9-6.9-2.5 0-4.6 1.3-5.8 3.3-.3.5-1 .6-1.5.3-.5-.3-.6-1-.3-1.5C4.9 3.6 8.2 2 12 2z" fill="#e0e0e0"/>
        <path d="M6.5 9.5c3.1-1.1 6.4 0 8.2 2.7.6.9 1.7 1.3 2.7.9 0 0-1.5 3.8-6.2 5.2-3.4 1-6.6.1-8.6-1.1 0 0 2.1-.5 3.4-1.7 1.1-1 1.4-2.1 1.6-3.3.1-.9-.3-1.8-1.1-2.4z" fill="#e64a19"/>
        <circle cx="15.2" cy="10.8" r="1.2" fill="#ffeb3b"/>
      </svg>
    </div>
    <h1 class="brand">Ninja Timer</h1>
    <div class="header-spacer"></div>
    <button id="openOutput" class="header-btn output-btn" title="Open Output Window">Output</button>
    <button id="appSettingsBtn" class="header-settings-btn" title="Settings">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    </button>
  </header>

  <main class="main-compact">
    <!-- Live Preview (top, resizable) -->
    <div id="previewSection" class="preview-section">
      <div id="previewWrapper" class="live-preview-wrapper">
        <div id="livePreview" class="live-preview">
          <div id="livePreviewContentBox" class="content-box">
            <div class="timer-section">
              <div id="livePreviewTimer" class="timer-preview">10:00</div>
            </div>
            <div class="message-section">
              <div id="livePreviewMessage" class="message-preview"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="previewResizeHandle" class="preview-resize-handle">
        <div class="resize-grip"></div>
      </div>
    </div>

    <!-- Progress Bar (Interactive with seek functionality) -->
    <div id="timerProgressContainer" class="timer-progress-container">
      <!-- Interactive track -->
      <div class="progress-track" id="progressTrack">
        <!-- Inner clip area for fill and warning zones -->
        <div class="progress-clip">
          <!-- Warning zone backgrounds (yellow/orange) -->
          <div id="warningZones" class="warning-zones"></div>
          <!-- Elapsed fill -->
          <div id="progressFill" class="progress-fill"></div>
        </div>

        <!-- Time segment dividers -->
        <div id="progressSegments" class="progress-segments"></div>

        <!-- Current position indicator -->
        <div id="progressIndicator" class="progress-indicator"></div>

        <!-- Hover seek line (follows mouse) -->
        <div id="seekLine" class="seek-line hidden"></div>

        <!-- Hover time tooltip -->
        <div id="seekTooltip" class="seek-tooltip hidden">00:00</div>
      </div>
    </div>

    <!-- Control Buttons -->
    <div class="utility-bar">
      <button id="flashBtn" class="flash-btn">
        <svg class="flash-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        <span class="flash-text">Flash</span>
      </button>
      <button id="blackoutBtn" class="blackout-btn">
        <span class="blackout-indicator"></span>
        Blackout
      </button>
      <div class="utility-spacer"></div>
      <button id="profileBtn" class="profile-btn">
        <span id="profileColorDot" class="profile-color-dot"></span>
        <span id="profileName">Default</span>
        <svg class="profile-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
    </div>

    <!-- Tab Content Container -->
    <div class="tab-content-container">
      <!-- Timers Tab (default) -->
      <div id="timersTab" class="tab-content active">
        <div class="preset-list-container">
          <div id="presetList" class="preset-list"></div>
        </div>
      </div>

      <!-- Messages Tab -->
      <div id="messagesTab" class="tab-content">
        <div class="message-list-container">
          <div id="messageList" class="message-list"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Bar: Tab Icons + Add Timer -->
    <div class="bottom-bar">
      <button id="timersTabBtn" class="tab-icon-btn active" data-tab="timers" title="Timers">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span class="tab-badge" id="timersBadge"></span>
      </button>
      <button id="addTimer" class="add-timer-btn">+ Add Timer</button>
      <button id="messagesTabBtn" class="tab-icon-btn" data-tab="messages" title="Messages">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <span class="tab-badge" id="messagesBadge"></span>
      </button>
    </div>

    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </main>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Edit Timer</h2>
        <button id="modalClose" class="modal-close">&times;</button>
      </div>

      <div class="modal-body">
        <!-- Preview in modal - sticky section -->
        <div class="modal-preview-section">
          <div class="modal-preview-wrapper">
            <div id="modalPreview" class="modal-preview">
              <div id="modalPreviewTimer" class="timer-preview">10:00</div>
            </div>
          </div>
        </div>

        <!-- Duration controls - buttons + unified input -->
        <div class="duration-controls" id="durationControls">
          <!-- Hours (hidden when format is MM:SS) -->
          <div class="digit-group hours-group" id="hoursGroup">
            <div class="digit-col h0-col" id="h0Col">
              <button type="button" class="digit-btn digit-up" data-digit="h0">▲</button>
              <button type="button" class="digit-btn digit-down" data-digit="h0">▼</button>
            </div>
            <div class="digit-col">
              <button type="button" class="digit-btn digit-up" data-digit="h1">▲</button>
              <button type="button" class="digit-btn digit-down" data-digit="h1">▼</button>
            </div>
            <div class="digit-col">
              <button type="button" class="digit-btn digit-up" data-digit="h2">▲</button>
              <button type="button" class="digit-btn digit-down" data-digit="h2">▼</button>
            </div>
          </div>
          <span class="digit-separator hours-sep">:</span>
          <!-- Minutes -->
          <div class="digit-group minutes-group">
            <div class="digit-col">
              <button type="button" class="digit-btn digit-up" data-digit="m1">▲</button>
              <button type="button" class="digit-btn digit-down" data-digit="m1">▼</button>
            </div>
            <div class="digit-col">
              <button type="button" class="digit-btn digit-up" data-digit="m2">▲</button>
              <button type="button" class="digit-btn digit-down" data-digit="m2">▼</button>
            </div>
          </div>
          <span class="digit-separator minutes-sep">:</span>
          <!-- Seconds -->
          <div class="digit-group seconds-group">
            <div class="digit-col">
              <button type="button" class="digit-btn digit-up" data-digit="s1">▲</button>
              <button type="button" class="digit-btn digit-down" data-digit="s1">▼</button>
            </div>
            <div class="digit-col">
              <button type="button" class="digit-btn digit-up" data-digit="s2">▲</button>
              <button type="button" class="digit-btn digit-down" data-digit="s2">▼</button>
            </div>
          </div>
        </div>

        <!-- Timer Section -->
        <div class="collapsible-section" data-section="timer">
          <h3 class="section-header">
            <span>Timer</span>
            <svg class="chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </h3>
          <div class="section-content">
            <div class="kv">
              <label for="presetName">Title</label>
              <input id="presetName" type="text" placeholder="Timer 1" />
            </div>
            <div class="kv">
              <label for="mode">Mode</label>
              <select id="mode">
                <option value="countdown">Countdown</option>
                <option value="countup">Count Up</option>
                <option value="tod">Time of Day</option>
                <option value="countdown-tod">C/D + ToD</option>
                <option value="countup-tod">C/U + ToD</option>
              </select>
            </div>
            <div class="kv">
              <label for="format">Format</label>
              <select id="format">
                <option value="HH:MM:SS">HH:MM:SS</option>
                <option value="MM:SS" selected>MM:SS</option>
              </select>
            </div>
            <div class="kv">
              <label for="duration">Duration</label>
              <input id="duration" type="text" class="time-input duration-input" value="00:10:00" maxlength="10" placeholder="HH:MM:SS" />
            </div>
            <div class="kv" id="allowOvertimeRow">
              <label for="allowOvertime">Overtime</label>
              <select id="allowOvertime">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Appearance Section -->
        <div class="collapsible-section" data-section="appearance">
          <h3 class="section-header">
            <span>Appearance</span>
            <svg class="chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </h3>
          <div class="section-content">
            <div class="kv">
              <label for="fontColor">Text Color</label>
              <input id="fontColor" type="color" value="#ffffff" />
            </div>
            <div class="kv kv-inline">
              <label>Stroke</label>
              <div class="inline-controls">
                <input id="strokeWidth" type="number" min="0" max="20" step="1" value="0" class="number-stepper" />
                <span class="unit-label">px</span>
                <input id="strokeColor" type="color" value="#000000" />
              </div>
            </div>
            <div class="kv kv-inline">
              <label>Shadow</label>
              <div class="inline-controls">
                <input id="shadowSize" type="number" min="0" max="50" step="1" value="0" class="number-stepper" />
                <span class="unit-label">px</span>
                <input id="shadowColor" type="color" value="#000000" />
              </div>
            </div>
            <div class="kv">
              <label for="bgColor">Background</label>
              <input id="bgColor" type="color" value="#000000" />
            </div>
          </div>
        </div>

        <!-- Sound Section -->
        <div class="collapsible-section" data-section="sound">
          <h3 class="section-header">
            <span>Sound</span>
            <svg class="chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </h3>
          <div class="section-content">
            <div class="kv">
              <label for="soundEnd">End sound</label>
              <div class="sound-select-row">
                <select id="soundEnd">
                  <option value="none" selected>None</option>
                  <option value="chime">Chime</option>
                  <option value="bell">Bell</option>
                  <option value="alert">Alert</option>
                  <option value="gong">Gong</option>
                  <option value="soft">Soft</option>
                </select>
                <button type="button" id="soundPreview" class="icon-btn preview-btn" title="Preview sound">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="kv" id="volumeRow">
              <label for="soundVolume">Volume</label>
              <input id="soundVolume" type="range" min="0" max="1" step="0.1" value="0.7" />
            </div>
          </div>
        </div>

        <!-- Warning Section -->
        <div class="collapsible-section" data-section="warning">
          <h3 class="section-header">
            <span>Warning Colors</span>
            <svg class="chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </h3>
          <div class="section-content">
            <div class="kv">
              <label class="warn-label"><span class="warn-dot warn-dot-yellow"></span>Yellow at</label>
              <input id="warnYellowSec" type="text" class="time-input time-input-ms" value="01:00" maxlength="5" />
            </div>
            <div class="kv">
              <label class="warn-label"><span class="warn-dot warn-dot-orange"></span>Orange at</label>
              <input id="warnOrangeSec" type="text" class="time-input time-input-ms" value="00:15" maxlength="5" />
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="modalCancel" class="secondary">Cancel</button>
        <button id="modalSave">Save Timer</button>
      </div>
    </div>
  </div>

  <!-- App Settings Modal -->
  <div id="appSettingsModal" class="modal-overlay hidden">
    <div class="modal app-settings-modal">
      <div class="modal-header">
        <h2>Settings</h2>
        <button id="appSettingsClose" class="modal-close">&times;</button>
      </div>

      <div class="modal-body">
        <!-- General Section -->
        <div class="settings-section">
          <h3 class="settings-section-title">General</h3>
          <div class="kv">
            <label for="todFormat">Time of Day</label>
            <select id="todFormat">
              <option value="12h">12-hour</option>
              <option value="24h">24-hour</option>
            </select>
          </div>
          <div class="kv">
            <label for="timezone">Timezone</label>
            <select id="timezone">
              <!-- Populated by JavaScript -->
            </select>
          </div>
          <div class="kv">
            <label for="confirmDelete">Confirm delete</label>
            <select id="confirmDelete">
              <option value="on">Ask before deleting</option>
              <option value="off">Delete immediately</option>
            </select>
          </div>
          <div class="settings-row">
            <button id="settingsExport" class="secondary">Export Timers</button>
            <button id="settingsImport" class="secondary">Import Timers</button>
          </div>
        </div>

        <!-- Window Section -->
        <div class="settings-section">
          <h3 class="settings-section-title">Window</h3>
          <div class="kv">
            <label for="outputOnTop">Output stays on top</label>
            <select id="outputOnTop">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
          <div class="kv">
            <label for="controlOnTop">Control stays on top</label>
            <select id="controlOnTop">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
        </div>

        <!-- Default Timer Settings -->
        <div class="settings-section">
          <h3 class="settings-section-title">New Timer Defaults</h3>
          <p class="settings-hint">Settings applied when creating new timers</p>

          <div class="kv">
            <label for="defaultMode">Mode</label>
            <select id="defaultMode">
              <option value="countdown">Countdown</option>
              <option value="countup">Count Up</option>
              <option value="tod">Time of Day</option>
              <option value="countdown-tod">C/D + ToD</option>
              <option value="countup-tod">C/U + ToD</option>
            </select>
          </div>
          <div class="kv">
            <label>Duration</label>
            <input id="defaultDuration" type="text" class="time-input" value="00:10:00" maxlength="8" />
          </div>
          <div class="kv">
            <label for="defaultFormat">Format</label>
            <select id="defaultFormat">
              <option value="HH:MM:SS">HH:MM:SS</option>
              <option value="MM:SS">MM:SS</option>
            </select>
          </div>
          <div class="kv">
            <label for="defaultSound">End sound</label>
            <select id="defaultSound">
              <option value="none">None</option>
              <option value="chime">Chime</option>
              <option value="bell">Bell</option>
              <option value="alert">Alert</option>
              <option value="gong">Gong</option>
              <option value="soft">Soft</option>
            </select>
          </div>
          <div class="kv">
            <label for="defaultAllowOvertime">Overtime</label>
            <select id="defaultAllowOvertime">
              <option value="on">On</option>
              <option value="off">Off</option>
            </select>
          </div>
        </div>

        <!-- Display Section -->
        <div class="settings-section">
          <h3 class="settings-section-title">Display</h3>
          <div class="kv">
            <label for="timerZoom">Timer Size</label>
            <select id="timerZoom">
              <option value="75">Small</option>
              <option value="100" selected>Medium</option>
              <option value="125">Large</option>
            </select>
          </div>
        </div>

        <!-- OSC Integration Section -->
        <div class="settings-section">
          <h3 class="settings-section-title">OSC Integration</h3>
          <p class="settings-hint">Control Ninja Timer from Companion, Millumin, etc.</p>
          <div class="kv">
            <label for="oscEnabled">OSC Control</label>
            <select id="oscEnabled">
              <option value="off">Disabled</option>
              <option value="on">Enabled</option>
            </select>
          </div>
          <div class="kv" id="oscListenPortRow">
            <label for="oscListenPort">Listen Port</label>
            <input id="oscListenPort" type="number" min="1024" max="65535" value="8000" class="number-input" />
          </div>
          <div class="kv">
            <label for="oscFeedbackEnabled">Send Feedback</label>
            <select id="oscFeedbackEnabled">
              <option value="off">Disabled</option>
              <option value="on">Enabled</option>
            </select>
          </div>
          <div class="kv" id="oscFeedbackHostRow">
            <label for="oscFeedbackHost">Feedback Host</label>
            <input id="oscFeedbackHost" type="text" value="127.0.0.1" class="text-input" />
          </div>
          <div class="kv" id="oscFeedbackPortRow">
            <label for="oscFeedbackPort">Feedback Port</label>
            <input id="oscFeedbackPort" type="number" min="1024" max="65535" value="9000" class="number-input" />
          </div>
          <div id="oscStatus" class="osc-status"></div>
        </div>

        <!-- Updates Section -->
        <div class="settings-section">
          <h3 id="updatesSectionTitle" class="settings-section-title">Updates</h3>
          <div class="update-section">
            <span id="updateStatus"></span>
            <button id="refreshUpdates" class="icon-btn" title="Re-check for updates">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 2v6h-6"></path>
                <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                <path d="M3 22v-6h6"></path>
                <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
              </svg>
            </button>
            <button id="downloadUpdates" class="secondary hidden">Download Updates</button>
            <button id="restartApp" class="secondary hidden">Restart App</button>
          </div>
          <div id="downloadProgress" class="download-progress hidden">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
              <span class="progress-text" id="progressText">0%</span>
            </div>
            <span class="progress-time" id="progressTime"></span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="appSettingsSave">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Confirm Dialog -->
  <div id="confirmDialog" class="modal-overlay hidden">
    <div class="confirm-dialog">
      <div class="confirm-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="24" height="24" rx="4" fill="#1a1a1a"/>
          <path d="M12 2c4.8 0 8.5 3.7 8.5 8.5 0 2.6-1.1 4.9-2.9 6.5-.5.5-1.2.5-1.7 0-.4-.4-.4-1 0-1.5 1.3-1.2 2.1-2.9 2.1-4.8 0-3.8-3.1-6.9-6.9-6.9-2.5 0-4.6 1.3-5.8 3.3-.3.5-1 .6-1.5.3-.5-.3-.6-1-.3-1.5C4.9 3.6 8.2 2 12 2z" fill="#e0e0e0"/>
          <path d="M6.5 9.5c3.1-1.1 6.4 0 8.2 2.7.6.9 1.7 1.3 2.7.9 0 0-1.5 3.8-6.2 5.2-3.4 1-6.6.1-8.6-1.1 0 0 2.1-.5 3.4-1.7 1.1-1 1.4-2.1 1.6-3.3.1-.9-.3-1.8-1.1-2.4z" fill="#e64a19"/>
          <circle cx="15.2" cy="10.8" r="1.2" fill="#ffeb3b"/>
        </svg>
      </div>
      <h3 id="confirmTitle" class="confirm-title">Delete Timer?</h3>
      <p id="confirmMessage" class="confirm-message">This action cannot be undone.</p>
      <label class="confirm-checkbox-label" id="confirmDontAskContainer">
        <input type="checkbox" id="confirmDontAsk" />
        <span>Don't ask again</span>
      </label>
      <div class="confirm-buttons">
        <button id="confirmCancel" class="secondary">Cancel</button>
        <button id="confirmDeleteBtn" class="danger">Delete</button>
      </div>
    </div>
  </div>

  <footer>
    <small>v1.1.0</small>
  </footer>

  <script type="module" src="control.js"></script>
</body>
</html>
